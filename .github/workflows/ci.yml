name: CI

on:
  push:
    branches:
      - 'main'
  pull_request:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      core: ${{ steps.filter.outputs.core }}
      sqlite: ${{ steps.filter.outputs.sqlite }}
      postgres: ${{ steps.filter.outputs.postgres }}
      oracle: ${{ steps.filter.outputs.oracle }}
      mariadb: ${{ steps.filter.outputs.mariadb }}
      playwright: ${{ steps.filter.outputs.playwright }}
      kafka: ${{ steps.filter.outputs.kafka }}
      pulsar: ${{ steps.filter.outputs.pulsar }}
      eventhubs: ${{ steps.filter.outputs.eventhubs }}
      google_pubsub: ${{ steps.filter.outputs.google_pubsub }}
      iggy: ${{ steps.filter.outputs.iggy }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'src/**'
              - 'pyproject.toml'
              - 'tests/**'
            sqlite:
              - 'plugins/sqlite/**'
            postgres:
              - 'plugins/postgres/**'
            oracle:
              - 'plugins/oracle/**'
            mariadb:
              - 'plugins/mariadb/**'
            playwright:
              - 'plugins/playwright/**'
            kafka:
              - 'plugins/kafka/**'
            pulsar:
              - 'plugins/pulsar/**'
            eventhubs:
              - 'plugins/eventhubs/**'
            google_pubsub:
              - 'plugins/google_pubsub/**'
            iggy:
              - 'plugins/iggy/**'

  build-core:
    needs: detect-changes
    if: needs.detect-changes.outputs.core == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -e ".[dev]"
      - name: Run tests
        run: pytest tests/unit/ -v --ignore=tests/unit/test_sqlite_plugin.py --ignore=tests/unit/test_postgres_plugin.py --ignore=tests/unit/test_oracle_plugin.py --ignore=tests/unit/test_mariadb_plugin.py --ignore=tests/unit/test_playwright_plugin.py --ignore=tests/unit/test_kafka_plugin.py --ignore=tests/unit/test_pulsar_plugin.py --ignore=tests/unit/test_google_pubsub_plugin.py --ignore=tests/unit/test_iggy_plugin.py --ignore=tests/unit/test_eventhubs_plugin.py

  build-sqlite:
    needs: detect-changes
    if: needs.detect-changes.outputs.sqlite == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/sqlite
      - name: Run tests
        run: pytest tests/unit/test_sqlite_plugin.py -v

  build-postgres:
    needs: detect-changes
    if: needs.detect-changes.outputs.postgres == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/postgres
      - name: Run tests
        run: pytest tests/unit/test_postgres_plugin.py -v

  build-oracle:
    needs: detect-changes
    if: needs.detect-changes.outputs.oracle == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/oracle
      - name: Run tests
        run: pytest tests/unit/test_oracle_plugin.py -v

  build-mariadb:
    needs: detect-changes
    if: needs.detect-changes.outputs.mariadb == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/mariadb
      - name: Run tests
        run: pytest tests/unit/test_mariadb_plugin.py -v

  build-playwright:
    needs: detect-changes
    if: needs.detect-changes.outputs.playwright == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/playwright
      - name: Run tests
        run: pytest tests/unit/test_playwright_plugin.py -v

  build-kafka:
    needs: detect-changes
    if: needs.detect-changes.outputs.kafka == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/kafka
      - name: Run tests
        run: pytest tests/unit/test_kafka_plugin.py -v

  build-pulsar:
    needs: detect-changes
    if: needs.detect-changes.outputs.pulsar == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/pulsar
      - name: Run tests
        run: pytest tests/unit/test_pulsar_plugin.py -v
  
  build-eventhubs:
    needs: detect-changes
    if: needs.detect-changes.outputs.eventhubs == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/eventhubs
      - name: Run tests
        run: pytest tests/unit/test_eventhubs_plugin.py -v

  build-google-pubsub:
    needs: detect-changes
    if: needs.detect-changes.outputs.google_pubsub == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/google_pubsub
      - name: Run tests
        run: pytest tests/unit/test_google_pubsub_plugin.py -v

  build-iggy:
    needs: detect-changes
    if: needs.detect-changes.outputs.iggy == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e plugins/iggy
      - name: Run tests
        run: pytest tests/unit/test_iggy_plugin.py -v

  ci:
    if: always()
    permissions:
      contents: read
    needs:
      - build-core
      - build-sqlite
      - build-postgres
      - build-oracle
      - build-mariadb
      - build-playwright
      - build-kafka
      - build-pulsar
      - build-eventhubs
      - build-google-pubsub
      - build-iggy
    runs-on: ubuntu-latest
    steps:
      - name: Check CI results
        run: |
          results=(
            "${{ needs.build-core.result }}"
            "${{ needs.build-sqlite.result }}"
            "${{ needs.build-postgres.result }}"
            "${{ needs.build-oracle.result }}"
            "${{ needs.build-mariadb.result }}"
            "${{ needs.build-playwright.result }}"
            "${{ needs.build-kafka.result }}"
            "${{ needs.build-pulsar.result }}"
            "${{ needs.build-eventhubs.result }}"
            "${{ needs.build-google-pubsub.result }}"
            "${{ needs.build-iggy.result }}"
          )
          for result in "${results[@]}"; do
            if [ "$result" == "failure" ] || [ "$result" == "cancelled" ]; then
              echo "CI failed: one or more jobs did not pass"
              exit 1
            fi
          done
          echo "CI passed"
